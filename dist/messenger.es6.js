/* 
* Messenger.js 
* v0.8.12
* The MIT License (MIT)
* Copyright (c) 2013-2018 ZhangLei (zhanglei923@gmail.com)
* https://github.com/zhanglei923/messenger.js
*/
import md5 from 'blueimp-md5'
"use strict";var messenger={},a025085040275294435=md5;function doPostMessage(e,n,t,s){if(e.postMessage){var r=n.messengerjs;delete r.isReq,delete r.isResp,delete r.from,r.isReq=void 0,r.isResp=void 0,r.from=void 0,r=JSON.parse(JSON.stringify(r));var o={};for(var i in r)"isReq"!==i&&"isResp"!==i&&"from"!==i&&(o[i]=r[i]);var a={messengerjs:o};e.postMessage(a,t,s)}}function encodeStr(e){for(var n=e.length/2,t=e.substring(0,n),s=e.substring(n),r=t.split("").reverse(),o=s.split("").reverse(),i=[].concat(r).concat(o),a=((a025085040275294435(""+Math.random()+new Date)+a025085040275294435(""+Math.random()+new Date)).split(""),(a025085040275294435(""+Math.random()+new Date)+a025085040275294435(""+Math.random()+new Date)).split(""),[]),d=0;d<i.length;d++)a.push(makeRandomAlphabet()+i[d]+makeRandomAlphabet());return a.join("")}function decodeStr(e){for(var n=e.split("").reverse(),t=1,s="";t;)n.shift(),(t=n.shift())&&(s+=t),n.shift();var r=s.length/2,o=s.substring(0,r),i=s.substring(r),a=o.split("");return s=i.split("").join("")+a.join("")}function makeRandomAlphabet(e){var n="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZ",s=t.toUpperCase(),r=t.toLowerCase(),o=s+r;return void 0!==e&&"upper"===e&&(o=s),void 0!==e&&"lower"===e&&(o=r),n+=o.charAt(Math.floor(Math.random()*o.length))}function makeRandomNumber(){var e="",n="0123456789";return e+=n.charAt(Math.floor(Math.random()*n.length))}function makeRespCode(){return makeRandomAlphabet()}function isRespCode(e){var n=e.substring(0,1);return/\b[a-zA-Z]\b/.test(n)}function makeReqCode(){return makeRandomNumber()}function isReqCode(e){var n=e.substring(0,1);return/\b[0-9]\b/.test(n)}function encryptFromCode(e,n){return"self"===n?0:"child"===n?1:"parent"===n?2:void 0}function decryptFromCode(e,n){var t=n.substring(1,2);return"0"===t?"self":"1"===t?"child":"2"===t?"parent":void 0}function encryptMessageData(e,n){var t=n.isResp,s=n.isReq;if(n.isResp){t=makeRespCode();e.info=""+t}if(n.isReq){s=makeReqCode();e.info=""+s}var r=encryptFromCode({isReq:s,isResp:t},n.from);e.info+=r,s&&(e.info+=n.requestPageId),t&&(e.info+=n.responsePageId);var o=n.responseToken,i=o.length,a=void 0;32===i&&(a=32),96===i&&(a=96),32===i&&(o=o+a025085040275294435(Math.random())+a025085040275294435(Math.random())),e.info+=a+o;var d=!!n.eventName,u=a025085040275294435(Math.random());return e.info+=(d?"1":"0")+(d?n.eventName:u),e.info=encryptInfo(e.info),e}function decryptMessageData(e){e.info=decryptInfo(e.info);var n=isRespCode(e.info),t=isReqCode(e.info),s={};n&&(s.isResp=!0),t&&(s.isReq=!0),s.from=decryptFromCode({isReq:t,isResp:n},e.info);var r=e.info.substring(2),o=r.substring(0,32);r=r.substring(32),t&&(s.requestPageId=o),n&&(s.responsePageId=o);var i=r.substring(0,2);r=r.substring(2);var a=parseInt(i),d=r.substring(0,96);r=r.substring(96),32===a&&(d=d.substring(0,a)),s.responseToken=d;var u="1"===r.substring(0,1),f=(r=r.substring(1)).substring(0,32);return r=r.substring(32),u&&(s.eventName=f),s}new Promise(function(e,n){});var SHOULD_DECRYPT_CODE=a025085040275294435(new Date+""),encryptInfo=function(e){var n=e.split(""),t=(n=n.reverse()).join("");return t=encodeStr(t+="z"),t=SHOULD_DECRYPT_CODE+t},decryptInfo=function(e){if(0!==e.indexOf(SHOULD_DECRYPT_CODE))return e;var n=(e=(e=decodeStr(e=e.substring(SHOULD_DECRYPT_CODE.length))).substring(0,e.length-1)).split("");return(n=n.reverse()).join("")};!function(n){var a=function(){var e=1.7*Math.random()+"-"+2.3*new Date;return a025085040275294435(e.replace(/\./gi,""))},t=window.parent,d={},u=""+a();n.getPageId=function(){return u},n.getTargetWindows=function(){var e=[];e.push({is:"self",from:"self",win:window}),window!==window.parent&&e.push({is:"parent",from:"child",win:window.parent});for(var n=document.getElementsByTagName("iframe"),t=0;t<n.length;t++)e.push({is:"child",from:"parent",win:n[t].contentWindow});return e},n.setTarget=function(e){return(t=e).contentWindow&&(t=t.contentWindow),n},n.emit=function(){var e=arguments[0];e=a025085040275294435(e);for(var n=[],t=1;t<arguments.length;t++)n.push(arguments[t]);var s=""+a(),r=this.getTargetWindows();for(t=0;t<r.length;t++){var o=r[t];("sent-req:",e,s,o);var i={messengerjs:{args:n}};i.messengerjs=encryptMessageData(i.messengerjs,{eventName:e,isReq:!0,from:o.from,requestPageId:u,responseToken:s}),i=JSON.parse(JSON.stringify(i)),doPostMessage(o.win,i,"*")}return d[s]={receiveCount:0},{onResponse:function(e){d[s].cb=e}}};var e=function(e){if((e=e.data)&&e.messengerjs){var n=decryptMessageData(e.messengerjs),t=decodeStr(n.responseToken);e.messengerjs&&e.messengerjs.info&&n.isResp&&d[t]&&s(t,e.messengerjs)}},s=function(e,n){var t=n.result,s=++d[e].receiveCount;d[e].cb&&d[e].cb(t,{count:s,stopReceive:function(){delete d[e]}})};window.addEventListener?window.addEventListener("message",e):window.attachEvent&&window.attachEvent("onmessage",e)}(messenger),function(i){var f={},e=function(e){(e=e.data)&&e.messengerjs&&n(e.messengerjs)},g=function(e,n){for(var t=i.getTargetWindows(),s=0;s<t.length;s++){var r=t[s],o={messengerjs:{result:n}};o.messengerjs=encryptMessageData(o.messengerjs,{isResp:!0,from:r.from,responsePageId:i.getPageId(),responseToken:encodeStr(e)}),o=JSON.parse(JSON.stringify(o)),doPostMessage(r.win,o,"*")}},n=function(e){var n=e.args,t=decryptMessageData(e),s=t.eventName,r=t.responseToken,o=f[s];if(o&&e&&t.isReq){var i=o.apply(window,n);i&&"function"==typeof i.then?i.then(function(e){g(r,e)}):g(r,i)}if("parent"===t.from)for(var a=document.getElementsByTagName("iframe"),d=0;d<a.length;d++){t.from="parent";var u={messengerjs:e};u=JSON.parse(JSON.stringify(u)),doPostMessage(a[d].contentWindow,u,"*")}if("child"===t.from&&window!==window.parent){t.from="child";u={messengerjs:e};u=JSON.parse(JSON.stringify(u)),doPostMessage(window.parent,u,"*")}};i.listen=function(e,n){e=a025085040275294435(e),f[e]=n},i.stopListen=function(e){e=a025085040275294435(e),delete f[e]},window.addEventListener?window.addEventListener("message",e):window.attachEvent&&window.attachEvent("onmessage",e),("listening...")}(messenger);;
export default messenger;
