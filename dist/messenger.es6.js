/* 
* Messenger.js 
* v0.8.12
* The MIT License (MIT)
* Copyright (c) 2013-2018 ZhangLei (zhanglei923@gmail.com)
* https://github.com/zhanglei923/messenger.js
*/
import md5 from 'blueimp-md5'
"use strict";var messenger={},a043014917979392586=md5;function doPostMessage(e,n,s,t){if(e.postMessage){var r=n.messengerjs;delete r.isReq,delete r.isResp,delete r.from,r.isReq=void 0,r.isResp=void 0,r.from=void 0,r=JSON.parse(JSON.stringify(r));var i={};for(var o in r)"isReq"!==o&&"isResp"!==o&&"from"!==o&&(i[o]=r[o]);var a={messengerjs:i};e.postMessage(a,s,t)}}new Promise(function(e,n){});var encrypt={};!function(){function p(e){for(var n=e.length/2,s=e.substring(0,n),t=e.substring(n),r=s.split("").reverse(),i=t.split("").reverse(),o=[].concat(r).concat(i),a=((a043014917979392586(""+Math.random()+new Date)+a043014917979392586(""+Math.random()+new Date)).split(""),(a043014917979392586(""+Math.random()+new Date)+a043014917979392586(""+Math.random()+new Date)).split(""),[]),g=0;g<o.length;g++)a.push(v()+o[g]+v());return a.join("")}function w(e){for(var n=e.split("").reverse(),s=1,t="";s;)n.shift(),(s=n.shift())&&(t+=s),n.shift();var r=t.length/2,i=t.substring(0,r),o=t.substring(r),a=i.split("");return t=o.split("").join("")+a.join("")}function v(e){var n="",s="ABCDEFGHIJKLMNOPQRSTUVWXYZ",t=s.toUpperCase(),r=s.toLowerCase(),i=t+r;return void 0!==e&&"upper"===e&&(i=t),void 0!==e&&"lower"===e&&(i=r),n+=i.charAt(Math.floor(Math.random()*i.length))}function l(){return e="",e+=(n="0123456789").charAt(Math.floor(Math.random()*n.length));var e,n}var h=a043014917979392586(new Date+"");encrypt.encodeStr=p,encrypt.decodeStr=w,encrypt.encryptMessageData=function(e,n){var s=n.isResp,t=n.isReq;n.isResp&&(s=v(),e.info=""+s);n.isReq&&(t=l(),e.info=""+t);var r,i="self"===(r=n.from)?0:"child"===r?1:"parent"===r?2:void 0;e.info+=i,t&&(e.info+=n.requestPageId),s&&(e.info+=n.responsePageId);var o=n.responseToken,a=o.length,g=void 0;32===a&&(g=32),96===a&&(g=96),32===a&&(o=o+a043014917979392586(Math.random())+a043014917979392586(Math.random())),e.info+=g+o;var d,f,u,c=!!n.eventName,m=a043014917979392586(Math.random());return e.info+=(c?"1":"0")+(c?n.eventName:m),e.info=(d=e.info,f=d.split(""),u=(f=f.reverse()).join(""),u=p(u+="z"),u=h+u),e},encrypt.decryptMessageData=function(e){e.info=function(e){if(0!==e.indexOf(h))return e;var n=(e=(e=w(e=e.substring(h.length))).substring(0,e.length-1)).split("");return(n=n.reverse()).join("")}(e.info);var n,s,t,r,i,o,a=(n=e.info,s=n.substring(0,1),/\b[a-zA-Z]\b/.test(s)),g=(t=e.info,r=t.substring(0,1),/\b[0-9]\b/.test(r)),d={};a&&(d.isResp=!0),g&&(d.isReq=!0),d.from=(i=e.info,"0"===(o=i.substring(1,2))?"self":"1"===o?"child":"2"===o?"parent":void 0);var f=e.info.substring(2),u=f.substring(0,32);f=f.substring(32),g&&(d.requestPageId=u),a&&(d.responsePageId=u);var c=f.substring(0,2);f=f.substring(2);var m=parseInt(c),p=f.substring(0,96);f=f.substring(96),32===m&&(p=p.substring(0,m)),d.responseToken=p;var v="1"===f.substring(0,1),l=(f=f.substring(1)).substring(0,32);return f=f.substring(32),v&&(d.eventName=l),d}}(),function(n){var a=function(){var e=1.7*Math.random()+"-"+2.3*new Date;return a043014917979392586(e.replace(/\./gi,""))},s=window.parent,g={},d=""+a();n.getPageId=function(){return d},n.getTargetWindows=function(){var e=[];e.push({is:"self",from:"self",win:window}),window!==window.parent&&e.push({is:"parent",from:"child",win:window.parent});for(var n=document.getElementsByTagName("iframe"),s=0;s<n.length;s++)e.push({is:"child",from:"parent",win:n[s].contentWindow});return e},n.setTarget=function(e){return(s=e).contentWindow&&(s=s.contentWindow),n},n.emit=function(){var e=arguments[0];e=a043014917979392586(e);for(var n=[],s=1;s<arguments.length;s++)n.push(arguments[s]);var t=""+a(),r=this.getTargetWindows();for(s=0;s<r.length;s++){var i=r[s];("sent-req:",e,t,i);var o={messengerjs:{args:n}};o.messengerjs=encrypt.encryptMessageData(o.messengerjs,{eventName:e,isReq:!0,from:i.from,requestPageId:d,responseToken:t}),o=JSON.parse(JSON.stringify(o)),doPostMessage(i.win,o,"*")}return g[t]={receiveCount:0},{onResponse:function(e){g[t].cb=e}}};var e=function(e){if((e=e.data)&&e.messengerjs){var n=encrypt.decryptMessageData(e.messengerjs),s=encrypt.decodeStr(n.responseToken);e.messengerjs&&e.messengerjs.info&&n.isResp&&g[s]&&t(s,e.messengerjs)}},t=function(e,n){var s=n.result,t=++g[e].receiveCount;g[e].cb&&g[e].cb(s,{count:t,stopReceive:function(){delete g[e]}})};window.addEventListener?window.addEventListener("message",e):window.attachEvent&&window.attachEvent("onmessage",e)}(messenger),function(o){var f={},e=function(e){(e=e.data)&&e.messengerjs&&n(e.messengerjs)},u=function(e,n){for(var s=o.getTargetWindows(),t=0;t<s.length;t++){var r=s[t],i={messengerjs:{result:n}};i.messengerjs=encrypt.encryptMessageData(i.messengerjs,{isResp:!0,from:r.from,responsePageId:o.getPageId(),responseToken:encrypt.encodeStr(e)}),i=JSON.parse(JSON.stringify(i)),doPostMessage(r.win,i,"*")}},n=function(e){var n=e.args,s=encrypt.decryptMessageData(e),t=s.eventName,r=s.responseToken,i=f[t];if(i&&e&&s.isReq){var o=i.apply(window,n);o&&"function"==typeof o.then?o.then(function(e){u(r,e)}):u(r,o)}if("parent"===s.from)for(var a=document.getElementsByTagName("iframe"),g=0;g<a.length;g++){s.from="parent";var d={messengerjs:e};d=JSON.parse(JSON.stringify(d)),doPostMessage(a[g].contentWindow,d,"*")}if("child"===s.from&&window!==window.parent){s.from="child";d={messengerjs:e};d=JSON.parse(JSON.stringify(d)),doPostMessage(window.parent,d,"*")}};o.listen=function(e,n){e=a043014917979392586(e),f[e]=n},o.stopListen=function(e){e=a043014917979392586(e),delete f[e]},window.addEventListener?window.addEventListener("message",e):window.attachEvent&&window.attachEvent("onmessage",e),("listening...")}(messenger);;
export default messenger;
