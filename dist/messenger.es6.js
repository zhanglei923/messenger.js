/* 
* Messenger.js 
* v0.8.8
* The MIT License (MIT)
* Copyright (c) 2013-2018 ZhangLei (zhanglei923@gmail.com)
* https://github.com/zhanglei923/messenger.js
*/
import md5 from 'blueimp-md5'
"use strict";var messenger={},a08329827531659046=md5;function encodeStr(e){for(var n=e.length/2,t=e.substring(0,n),s=e.substring(n),r=t.split("").reverse(),o=s.split("").reverse(),a=[].concat(r).concat(o),i=(a08329827531659046(""+Math.random()+new Date)+a08329827531659046(""+Math.random()+new Date)).split(""),d=(a08329827531659046(""+Math.random()+new Date)+a08329827531659046(""+Math.random()+new Date)).split(""),g=[],m=0;m<a.length;m++)g.push(i[m]+a[m]+d[m]);return g.join("")}function decodeStr(e){for(var n=e.split("").reverse(),t=1,s="";t;)n.shift(),(t=n.shift())&&(s+=t),n.shift();var r=s.length/2,o=s.substring(0,r),a=s.substring(r),i=o.split("");return s=a.split("").join("")+i.join("")}function makeRandomAlphabet(e){var n="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZ",s=t.toUpperCase(),r=t.toLowerCase(),o=s+r;return void 0!==e&&"upper"===e&&(o=s),void 0!==e&&"lower"===e&&(o=r),n+=o.charAt(Math.floor(Math.random()*o.length))}function makeRandomNumber(){var e="",n="0123456789";return e+=n.charAt(Math.floor(Math.random()*n.length))}function makeRespCode(){return makeRandomAlphabet()}function isRespCode(e){var n=e.substring(0,1);return/\b[a-zA-Z]\b/.test(n)}function makeReqCode(){return makeRandomNumber()}function isReqCode(e){var n=e.substring(0,1);return/\b[0-9]\b/.test(n)}function encryptMessageData(e){if(e.isResp){var n=makeRespCode();e.info=""+n,delete e.isResp}if(e.isReq){var t=makeReqCode();e.info=""+t,delete e.isReq}return e}function decryptMessageData(e){var n=isRespCode(e.info),t=isReqCode(e.info);return n&&(e.isResp=!0),t&&(e.isReq=!0),e}new Promise(function(e,n){}),function(n){var i=function(){var e=1.7*Math.random()+"-"+2.3*new Date;return a08329827531659046(e.replace(/\./gi,""))},t=window.parent,d={},g=""+i();n.getPageId=function(){return g},n.getTargetWindows=function(){var e=[];e.push({is:"self",from:"self",win:window}),window!==window.parent&&e.push({is:"parent",from:"child",win:window.parent});for(var n=document.getElementsByTagName("iframe"),t=0;t<n.length;t++)e.push({is:"child",from:"parent",win:n[t].contentWindow});return e},n.setTarget=function(e){return(t=e).contentWindow&&(t=t.contentWindow),n},n.emit=function(){var e=arguments[0];e=a08329827531659046(e);for(var n=[],t=1;t<arguments.length;t++)n.push(arguments[t]);var s=""+i(),r=this.getTargetWindows();for(t=0;t<r.length;t++){var o=r[t];if(o.win.postMessage){("sent-req:",e,s,o);var a={messengerjs:{isReq:!0,eventName:e,args:n,responseToken:s,requestPageId:g,from:o.from}};a.messengerjs=encryptMessageData(a.messengerjs),a=JSON.parse(JSON.stringify(a)),o.win.postMessage(a,"*")}}return d[s]={receiveCount:0},{onResponse:function(e){d[s].cb=e}}};var e=function(e){if((e=e.data)&&e.messengerjs){var n=decodeStr(e.messengerjs.responseToken);e.messengerjs&&e.messengerjs.info&&(e.messengerjs=decryptMessageData(e.messengerjs),e.messengerjs.isResp&&d[n]&&s(n,e.messengerjs))}},s=function(e,n){var t=n.result,s=++d[e].receiveCount;d[e].cb&&d[e].cb(t,{count:s,stopReceive:function(){delete d[e]}})};window.addEventListener?window.addEventListener("message",e):window.attachEvent&&window.attachEvent("onmessage",e)}(messenger),function(a){var g={},e=function(e){(e=e.data)&&e.messengerjs&&n(e.messengerjs)},m=function(e,n){for(var t=a.getTargetWindows(),s=0;s<t.length;s++){var r=t[s];if(r.win.postMessage){var o={messengerjs:{isResp:!0,responsePageId:a.getPageId(),responseToken:encodeStr(e),result:n,from:r.from}};o.messengerjs=encryptMessageData(o.messengerjs),o=JSON.parse(JSON.stringify(o)),r.win.postMessage(o,"*")}}},n=function(e){var n=e.args,t=e.eventName,s=e.responseToken,r=g[t];if(e=decryptMessageData(e),r&&e&&e.isReq){var o=r.apply(window,n);o&&"function"==typeof o.then?o.then(function(e){m(s,e)}):m(s,o)}if("parent"===e.from)for(var a=document.getElementsByTagName("iframe"),i=0;i<a.length;i++){e.from="parent";var d={messengerjs:e};d=JSON.parse(JSON.stringify(d)),a[i].contentWindow.postMessage(d,"*")}if("child"===e.from&&window!==window.parent){e.from="child";d={messengerjs:e};d=JSON.parse(JSON.stringify(d)),window.parent.postMessage(d,"*")}};a.listen=function(e,n){e=a08329827531659046(e),g[e]=n},a.stopListen=function(e){e=a08329827531659046(e),delete g[e]},window.addEventListener?window.addEventListener("message",e):window.attachEvent&&window.attachEvent("onmessage",e),("listening...")}(messenger);;
export default messenger;
